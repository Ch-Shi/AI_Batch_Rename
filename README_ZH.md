# 图像智能重命名工具

[English](README.md) | [中文](README_ZH.md)

这是一个基于 AI 的图像智能重命名工具，支持使用本地 Ollama 服务或硅基流动 API 来分析和重命名图片。

## 功能特点

- 支持多种图片格式（jpg, jpeg, png, gif, bmp, webp）
- 提供多种重命名模式：
  - 覆盖模式：直接使用 AI 生成的新名称
  - 前缀模式：保留原文件名，添加 AI 生成的新名称
  - 序号模式：新名称后添加序号（001-999）
- 支持批量处理
- 实时显示处理进度
- 详细的错误日志记录
- 支持本地 Ollama 服务和硅基流动 API
- 智能重名处理机制：
  - 自动检测重名情况
  - 重名时自动重新生成名称（最多尝试3次）
  - 记录重名处理日志
  - 处理完成后显示重名统计

## 版本说明

### 当前版本（v1.1.0）
- 优化了提示词和系统消息
- 添加了智能重名处理机制
- 改进了日志记录系统
- 提高了命名质量

### 待解决问题
- 进一步优化重名处理机制
- 改进命名风格的一致性
- 优化处理速度

## 系统要求

- Python 3.8 或更高版本
- Windows 操作系统
- 如果使用 Ollama 服务，需要安装 Ollama

## 安装步骤

1. 克隆或下载本项目到本地

2. 安装依赖包：
```bash
pip install -r requirements.txt
```

3. 如果使用 Ollama 服务：
   - 安装 Ollama（https://ollama.ai/）
   - 下载所需模型：
     ```bash
     ollama pull qwen2.5vl:3b
     ```

4. 如果使用硅基流动 API：
   - 在 `src/config.py` 中配置您的 API Key
   - 将 `USE_OLLAMA` 设置为 `False`

## 使用方法

### 方法一：使用批处理文件（推荐）

1. 双击运行 `start.bat`
2. 在菜单中选择重命名模式：
   - [1] 覆盖模式：直接使用新名称
   - [2] 前缀模式：保留原文件名
   - [3] 添加序号：新名称后添加序号
   - [4] 退出程序
3. 将图片文件夹拖放到窗口中，按回车开始处理

### 方法二：命令行方式

```bash
python src/main.py -i "图片文件夹路径" -m [override|prefix] -n
```

参数说明：
- `-i` 或 `--input_dir`：指定输入图片文件夹路径（必需）
- `-m` 或 `--mode`：选择重命名模式（可选）
  - `override`：覆盖模式（默认）
  - `prefix`：前缀模式
- `-n` 或 `--add_index`：添加序号（可选）

## 日志文件

程序会生成以下日志文件：
- `rename.log`：主日志文件，记录所有操作
- `rename_failures.log`：记录重命名失败的文件信息
- `token_usage.log`：记录 token 使用情况（仅在使用硅基流动 API 时）
- `duplicate_names.log`：记录重名处理情况

## 重名处理机制

程序采用以下策略处理重名情况：

1. 首次命名：
   - 使用 AI 生成新名称
   - 检查是否与已有名称重复

2. 发现重名时：
   - 自动重新生成名称（最多尝试3次）
   - 每次生成后检查是否仍有重名

3. 重名处理结果：
   - 如果3次尝试后仍有重名：添加序号（如：名称_1）
   - 记录重名信息到 `duplicate_names.log`
   - 处理完成后在控制台显示重名统计

4. 重名统计信息包括：
   - 重名文件总数
   - 重名文件列表
   - 最终使用的名称

## 配置说明

配置文件位于 `src/config.py`，主要配置项包括：

### 通用配置
- `SUPPORTED_FORMATS`：支持的图片格式
- `DEFAULT_MODE`：默认重命名模式
- `IMAGE_PROCESS_DELAY`：图片处理间隔时间
- `MAX_OUTPUT_TOKENS`：输出 token 限制

### API 配置
- `USE_OLLAMA`：是否使用 Ollama 服务
- `OLLAMA_MODEL`：Ollama 模型名称
- `SILICON_FLOW_API_KEY`：硅基流动 API 密钥
- `SILICON_FLOW_MODEL`：硅基流动模型名称

## 注意事项

1. 使用 Ollama 服务时：
   - 确保 Ollama 服务已启动
   - 建议使用本地模型以获得更快的处理速度
   - 没有 token 使用限制

2. 使用硅基流动 API 时：
   - 需要有效的 API Key
   - 注意 token 使用限制
   - 建议适当调整处理间隔时间

3. 文件命名：
   - 新文件名会自动去除非法字符
   - 如果新文件名已存在，会自动添加时间戳
   - 建议定期备份重要文件

## 常见问题

1. 如果遇到 "Ollama 服务未启动" 错误：
   - 检查 Ollama 是否正确安装
   - 手动启动 Ollama 服务：`ollama serve`

2. 如果处理速度较慢：
   - 检查网络连接
   - 调整 `IMAGE_PROCESS_DELAY` 参数
   - 考虑使用本地 Ollama 服务

3. 如果出现编码错误：
   - 确保系统使用 UTF-8 编码
   - 检查文件名是否包含特殊字符

## 许可证

MIT License 



Eagle 专用 AI 批量重命名工具需求说明
1. 启动与用户交互
启动脚本为 start_en.bat。
启动后，提示用户在 Eagle 中选中想要重命名的目录，右键“复制链接”，然后粘贴到命令行。
支持多选，即可以一次性粘贴多个目录链接（如多行，每行一个 eagle://folder/xxxxxx）。
2. 目录与图像的关系
Eagle 资料库为多级目录结构，根目录下的 metadata.json 记录了所有目录的层级、ID、名称等信息。
用户粘贴的目录链接可能是任意层级的目录（顶层或子目录）。
如果用户粘贴的是上层目录，需要递归处理其所有子目录及其下的所有图片。
3. 图像文件夹结构
每张图片对应一个以 ID 命名的文件夹（如 MATCILPKQRCQQ.info）。
每个图片文件夹下通常有：
原始图像（如 A-1.png，文件名与 metadata.json 中 "name" 字段一致，扩展名由 "ext" 字段决定）
缩略图（如 A-1_thumbnail.png，可选，命名与主图一致，仅多了 _thumbnail 后缀）
metadata.json（存储该图像的元数据，包括 "name"、"folders"、"ext" 等字段）
4. 图像归属判断
每个图片的 metadata.json 中 "folders" 字段为列表，包含其所属 Eagle 目录的 ID。
只有 "folders" 字段包含目标目录 ID 的图片才会被处理。
5. 重命名流程
对所有目标目录（包括递归子目录）下的所有图片，进行如下操作：
读取图片文件夹下的 metadata.json，获取 "name" 和 "ext" 字段，定位原始图像文件（如 A-1.png）。
查找是否有对应的缩略图（如 A-1_thumbnail.png）。
用 AI 对原始图像进行命名，得到新名字（不带扩展名）。
修改 metadata.json 中的 "name" 字段为新名字（不带扩展名）。
重命名原始图像文件为新名字+扩展名。
如果有缩略图，也重命名为新名字_thumbnail+扩展名，保持与主图一致，仅后缀不同。
6. 文件筛选与健壮性
由于图片目录下可能有多余文件，必须以 metadata.json 中的 "name" 字段为准，在当前目录下查找与之匹配的原始图像和缩略图。
只处理属于指定 Eagle 目录（及其所有子目录）的图片。
7. 其他补充
新名字写入 metadata.json 时不带扩展名，实际文件名正常带扩展名。
缩略图仅重命名，不参与 AI 识别。
支持批量、多目录、递归处理。